#!/usr/bin/env ruby
require_relative 'cellect_env'

class CellectStart
  include CellectEnv

  def initialize
    setup_env_vars
    setup_puma_cmd
  end

  def run
    if ENV['DEBUG_CELLECT_START']
      p @env_vars
      p @puma_cmd
    end
    exit system(@env_vars, @puma_cmd)
  end

  private

  def setup_puma_cmd
    @puma_cmd = "puma -b tcp://0.0.0.0:80 -t 0:#{puma_max_threads}"
  end

  def puma_max_threads
    max_threads = ENV['PUMA_MAX_THREADS'] || @pg_pool
    if max_threads.nil? || max_threads.empty?
      16
    else
      max_threads
    end
  end
end


CellectStart.new.run
